= π’¬ Chat API
:doctype: book
:icons: font
:source-highlighter: highlightjs
:toc: left
:toclevels: 3
:sectlinks:

== π  μ±„ν…λ°© μ‘λ‹µμ½”λ“(C01)

|===
| κΈ°λ¥ μ½”λ“ | μ„¤λ…

| 00 | μ±„ν…λ°© κ²€μƒ‰
| 01 | μ±„ν…λ°© μƒμ„±
| 02 | μ±„ν…λ°© μ‚­μ 
| 03 | μ±„ν…λ°© μ •λ³΄ κ°±μ‹ 
| 04 | μ±„ν…λ°© μ°Έμ—¬
| 05 | μ±„ν…λ°© νƒν‡΄
| 06 | μ±„ν…λ°© κ¶ν•
|===

== π’¬ μ±„ν… μ‘λ‹µμ½”λ“(C02)

|===
| κΈ°λ¥ μ½”λ“ | μ„¤λ…


|===

== β¨ API λ¬Έμ„

===  μ±„ν…λ°© API
''''
==== 1. μ±„ν…λ°© μ •λ³΄ μ΅°ν

*Description* +

'''

νΉμ • μ±„ν…λ°©μ— λ€ν• μ •λ³΄λ¥Ό path parameterλ΅ λ°›μ•„ μ΅°ν ν›„ λ°ν™ν•©λ‹λ‹¤.

μ±„ν…λ°© μ•„μ΄λ””λ” UUID κ°’μ…λ‹λ‹¤.
κ° μ±„ν… μ•„μ΄λ””λ” 64λΉ„νΈ 16μ§„μ λ¬Έμμ—΄μ…λ‹λ‹¤.

cursor  λ” κ° μ‚¬μ©μκ°€ κ°€μ¥ λ§μ§€λ§‰μΌλ΅ μ½μ€ λ©”μ‹μ§€μ μ•„μ΄λ””μ— λ€ν• λ°μ΄ν„°μ…λ‹λ‹¤.
logs    λ” ν•΄λ‹Ή μ±„ν…λ°©μ μµμ‹ μ 100κ°(μ¤μ°¨κ°€λ¥) λ°μ΄ν„°λ¥Ό λ°ν™ν•©λ‹λ‹¤.

[NOTE]
μ¶”ν›„ λ΅κ·Έ κ°™μ€ κ²½μ°λ” paging μ„ ν†µν•΄, κ°λ³„μ μΈ endpoint λ΅ λ¶„λ¦¬λ  κ°€λ¥μ„±μ΄ μ΅΄μ¬ν•©λ‹λ‹¤.


*REQUEST* +

'''

include::{snippets}/chat-room-controller-rest-docs-test/get-chat-room-info_success/path-parameters.adoc[]
include::{snippets}/chat-room-controller-rest-docs-test/get-chat-room-info_success/http-request.adoc[]


*RESPONSE* +

'''

include::{snippets}/chat-room-controller-rest-docs-test/get-chat-room-info_success/response-fields.adoc[]
include::{snippets}/chat-room-controller-rest-docs-test/get-chat-room-info_success/http-response.adoc[]

'''
'''

=== μ±„ν…

'''
==== - CONNECT frame

ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„
[source,stomp]
----
CONNECT
accept-version:1.2
host:{HOST}
Authorization:Bearer {ACCESS_TOKEN}

^@
----
[NOTE]
`{ACCESS_TOKEN}` μ€ λ΅κ·ΈμΈλ¶€ν„° λ°κΈ‰λ°›μ€ ν† ν°μ„ μ‚¬μ©ν•©λ‹λ‹¤.

'''
==== - SUBSCRIBE frame (μ±„ν…λ°© κµ¬λ…)

ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„

[source,stomp]
----
SUBSCRIBE
id:sub-0
destination:/sub/chat/room/{chatRoomId}

^@
----

μ„λ²„λ” μ΄ν›„ `/sub/chat/room/{chatRoomId}` λ΅ μ „λ‹¬λλ” MESSAGE ν”„λ μ„μ„
ν•΄λ‹Ή μ„Έμ…μΌλ΅ push ν•΄μ•Όν•©λ‹λ‹¤.

'''
==== - SEND frame (μ±„ν… λ©”μ‹μ§€ μ „μ†΅)

[WARNING]
ν΄λΌμ΄μ–ΈνΈμ—μ„λ” λ©”μ‹μ§€λ¥Ό λ³΄λ‚Ό λ•, λ‹¤μκ³Ό κ°™μ€ λ°©μ‹μΌλ΅ λ³΄λ‚΄μ•Ό ν•©λ‹λ‹¤. λ‹¨, SEND μ‹ μ‚¬μ©λλ” chatRoomId λ”,
ν„μ¬ μ„Έμ…μ—μ„ κµ¬λ…μ΄ λμ–΄ μμ–΄μ•Ό ν•©λ‹λ‹¤. λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈμ μ„Έμ…μ—μ„, λ™μΌν• μ‚¬μ©μκ°€ κµ¬λ…μ„ ν–λ”λΌλ„ ν•΄λ‹Ή μ„Έμ…μ— κµ¬λ…μ΄ λμ–΄ μμ§€ μ•μΌλ©΄
μ „μ†΅μ΄ λμ§€ μ•μµλ‹λ‹¤.

DESTINATION : /pub/read/message

ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„

[source,stomp]
----
SEND
destination:/pub/send/message
content-type:application/json

{
  "roomId": "{chatRoomId}",
  "type": "TEXT",
  "message": "μ•λ…•ν•μ„Έμ”, λ‚΄μΌ 10μ‹μ— νμν• κΉμ”?"
}
^@
----

μ„λ²„ β†’ ν΄λΌμ΄μ–ΈνΈ (μμ‹ μ‘λ‹µ MESSAGE)

[source,stomp]
----
MESSAGE
subscription:sub-0
destination:/sub/chat/room/{chatRoomId}
message-id:msg-15

{
  "id": "15",
  "type": "TEXT",
  "message": "μ•λ…•ν•μ„Έμ”, λ‚΄μΌ 10μ‹μ— νμν• κΉμ”?",
  "sender": 1
}
^@
----

'''

==== - SEND frame (μ½μ μ²λ¦¬)

ν΄λΌμ΄μ–ΈνΈλ” λ©”μ‹μ§€λ¥Ό μ½μΌλ©΄, κ°€μ¥ λ§μ§€λ§‰μΌλ΅ μ½μ€ λ©”μ‹μ§€λ¥Ό μ„λ²„λ΅ λ³΄λ‚΄μ•Ό ν•©λ‹λ‹¤.
μ΄λ” ν•„μμ μΈ κ³Όμ •μ΄λ©° ν΄λΌμ΄μ–ΈνΈ μΈ΅μ—μ„ μ–΄λμ •λ„ μµμ ν™”λ¥Ό ν•λ©΄ μ„λ²„ μΈ΅μ λ¶€λ‹΄μ΄ μ¤„μ–΄λ“¤ μ—¬μ§€κ°€ μμµλ‹λ‹¤.

1. κ°€λ Ή λ§¤μ° μ§§μ€ μ‹κ°„μ— μ κ±΄μ λ©”μ‹μ§€κ°€ μ¨λ‹¤λ©΄, κ°€μ¥ λ§μ§€λ§‰ λ©”μ‹μ§€λ§ "μ½μ μ™„λ£" μ²λ¦¬λ¥Ό μν–‰ν•  μ μμµλ‹λ‹¤. μ„λ²„λ” μ–΄μ¨‹κ±°λ‚
κ°€μ¥ λ§μ§€λ§‰ λ©”μ‹μ§€λ§ μµμ‹ ν™” ν•λ©΄ λ©λ‹λ‹¤.
2. λ‹¤λ§, μ–΄μ¨‹κ±°λ‚ μ μ €κ°€ λ³Έ κ°€μ¥ λ§μ§€λ§‰ λ©”μ‹μ§€λ¥Ό μ„λ²„λ΅ λ³΄λ‚Έλ‹¤λ” κ³Όμ •λ§ μν–‰ν•λ©΄ λ©λ‹λ‹¤. κ°‘μ‘μ¤λ¬μ΄ λ„¤νΈμ›ν¬ μ¤λ¥, μ–΄ν”λ¦¬μΌ€μ΄μ… μΆ…λ£ μ‹μ—λ„
μ•μ „ν•κ² λ§μ§€λ§‰μΌλ΅ μ½μ€ μ±„ν… μ •λ³΄λ¥Ό μ „μ†΅λ§ ν•  μ μμΌλ©΄ μ–΄λ–¤ λ°©μ‹λ„ μƒκ΄€μ΄ μ—†μµλ‹λ‹¤.

DESTINATION : /pub/read/message

ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„

[source,stomp]
----
SEND
destination:/pub/read/message
content-type:application/json

{
  "roomId": "{chatRoomId}",
  "chatId": "15"
}
^@
----
'''
==== - SUBSCRIBE frame (μ μ € κ°μΈ ν κµ¬λ…)

/user/queue λ” νΉμ • μ μ €μ—κ²λ§ μ „λ‹¬λλ” κ°μΈμ© λ©”μ‹μ§€λ¥Ό λ°›κΈ° μ„ν• μ±„λ„μ…λ‹λ‹¤.
ν΄λΌμ΄μ–ΈνΈλ” λ‹¤μκ³Ό κ°™μ΄ λ‹¨μν κµ¬λ…λ§ ν•λ©΄ λ©λ‹λ‹¤.

κµ¬λ… μ‹μ μ€ μ–΄ν”λ¦¬μΌ€μ΄μ…μ΄ μ‹μ‘λ  λ• μ…λ‹λ‹¤. μ ‘μ†μ΄ λκΈ°λ©΄ μ¬μ ‘μ†μ„ μ‹λ„ν•΄μ•Ό ν•λ©°, μ¬μ ‘μ†λ„ μ‹λ„ν•λ©΄ μ¤ν”„λΌμΈ λ¨λ“λ΅ μ „ν™ν•μ—¬μ•Ό ν•©λ‹λ‹¤.

DESTINATION : `/user/queue/notifications`

ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„

[source,stomp]
----
SUBSCRIBE
id:sub-user
destination:/user/queue/notifications

^@
----

μ΄ν›„ ν•΄λ‹Ή μ μ €μ—κ² μ „λ‹¬λλ” κ°μΈ λ©”μ‹μ§€κ°€ λ¨λ‘ μ΄ μ±„λ„λ΅ λ„μ°©ν•©λ‹λ‹¤.

'''
==== - USER QUEUE MESSAGE frame (κ°μΈ λ©”μ‹μ§€)

μ„λ²„ β†’ ν΄λΌμ΄μ–ΈνΈ

[source,stomp]
----
MESSAGE
subscription:sub-user
destination:/user/queue/notifications
message-id:user-msg-1

{
  "type": "NOTICE",
  "content": "μƒλ΅μ΄ μ•λ¦Όμ΄ μμµλ‹λ‹¤."
}
^@
----
[NOTE]
λ‹¨, κ°μΈ λ©”μ‹μ§€μ ν•μ‹μ€ μ•„μ§ μ •μλμ§€ μ•μ•μµλ‹λ‹¤.

'''
'''

=== μ±„ν…λ°© λ¦¬μ¤νΈ(SSE)
`/sse/chat/room/list`

ν΄λΌμ΄μ–ΈνΈλ” SSE λ¥Ό ν†µν•΄ μ μ €κ°€ μ†ν• μ±„ν…λ°© λ¦¬μ¤νΈλ¥Ό λ°›μ•„μ¬ μ μμµλ‹λ‹¤. ν„μ¬κΉμ§€ κµ¬ν„λ λ°”μ— λ”°λ¥΄λ©΄, λ°μ΄ν„°λ” μ΄ 2κ°€μ§€ νƒ€μ…μ΄ μ΅΄μ¬ν•©λ‹λ‹¤.

μµμ΄ μ—°κ²° ν›„ λ³΄λ‚΄μ§€λ” λ©”μ‹μ§€λ” μ—°κ²° μ‹μ μ μ±„ν…λ°© λ¦¬μ¤νΈ λ° κ° μ±„ν…λ°©μ λ°μ΄ν„°κ°€ ν¬ν•¨λ©λ‹λ‹¤.

- μ±„ν…λ°© μ•„μ΄λ””
- μ±„ν…λ°© μ΄λ¦„
- μ±„ν…λ°© μ΄λ―Έμ§€ URL
- μ°Έμ—¬μ μ
- μ• μ½μ€ λ©”μ‹μ§€ μΉ΄μ΄νΈ
- κ°€μ¥ λ§μ§€λ§‰ λ©”μ‹μ§€
- κ°€μ¥ λ§μ§€λ§‰ λ©”μ‹μ§€ μ•„μ΄λ””
- κ°€μ¥ λ§μ§€λ§‰ λ©”μ‹μ§€ sender id

μ΄ν›„ λ³΄λ‚΄μ§€λ” λ©”μ‹μ§€λ” μ΄κΈ° λ©”μ‹μ§€ μ΄ν›„ λ°ν–‰λλ” μƒλ΅μ΄ λ©”μ‹μ§€μ— λ€ν• μ •λ³΄μ…λ‹λ‹¤. κ° μ‚¬μ©μκ°€ λ©”μ‹μ§€λ¥Ό λ³΄λ‚΄κ² λλ©΄ μ ‘μ† μ¤‘μΈ SSE μ„Έμ…μΌλ΅
ν•΄λ‹Ή λ©”μ‹μ§€ μ •λ³΄κ°€ μ „μ†΅λ©λ‹λ‹¤. μ΄λ•μ λ°μ΄ν„°λ” μ±„ν…λ°©μ—μ„ λ°›λ” μƒλ΅μ΄ μ±„ν… λ°μ΄ν„°μ™€ λ™μΌν•©λ‹λ‹¤.

- μ±„ν…λ°© μ•„μ΄λ””
- μ±„ν… μ•„μ΄λ””
- μ±„ν… λ‚΄μ©
- μ±„ν… νƒ€μ…
- sender id

[NOTE]
λ¨λ“  SSE λ©”μ‹μ§€λ” type - body λ΅ κµ¬μ„±λ©λ‹λ‹¤. type μ€ ν•΄λ‹Ή λ©”μ‹μ§€μ μΆ…λ¥, body λ” μ‹¤μ  λ°μ΄ν„°μ…λ‹λ‹¤.

[NOTE]
SSE μ—°κ²° ν›„, μ±„ν…λ°© λ¦¬μ¤νΈλ¥Ό λ°›κΈ° μ „ `connect` type μ λ©”μ‹μ§€κ°€ λ¨Όμ € λ³΄λ‚΄μ§‘λ‹λ‹¤. μ΄λ” μ±„ν…λ°© λ¦¬μ¤νΈ API λΏ λ§ μ•„λ‹λΌ, SSE μ—°κ²°
λ¨λ‘μ— μ μ©λ©λ‹λ‹¤. body λ” μ—†μµλ‹λ‹¤. `(empty)`

'''

==== - [init-message]
λ‹¤μμ€ SSE μ΄κΈ° λ©”μ‹μ§€(`init-message`)λ΅ μ „λ‹¬λλ” μ±„ν…λ°© λ©λ΅ μ‘λ‹µμ ν•„λ“ μ„¤λ…μ΄λ‹¤.


|===
| Path | Type | Description

| rooms | Array | μ‚¬μ©μκ°€ κ°€μ…ν• μ±„ν…λ°© λ©λ΅

| rooms[].roomId
| String
| μ±„ν…λ°© ID (UUID)

| rooms[].name
| String
| μ±„ν…λ°© μ΄λ¦„

| rooms[].url
| String or null
| μ±„ν…λ°© λ€ν‘ μ΄λ―Έμ§€ URL. μ—†μΌλ©΄ null

| rooms[].totalMember
| Number
| ν„μ¬ μ±„ν…λ°© μ΄ λ©¤λ²„ μ

| rooms[].unread
| Number
| μ‚¬μ©μκ°€ μ½μ§€ μ•μ€ λ©”μ‹μ§€ μ
`-1`μ΄λ©΄ μµκ·Ό λ©”μ‹μ§€ μ—†μ (μ•„μ§ μ±„ν…λ°©μ— μ±„ν…μ΄ μ΅΄μ¬ν•μ§€ μ•μ)

| rooms[].content
| String or null
| λ§μ§€λ§‰ λ©”μ‹μ§€ λ‚΄μ©. λ©”μ‹μ§€κ°€ μ—†μΌλ©΄ null

| rooms[].chatId
| String or null
| λ§μ§€λ§‰ λ©”μ‹μ§€ ID. λ©”μ‹μ§€κ°€ μ—†μΌλ©΄ null

| rooms[].sender
| Number or null
| λ§μ§€λ§‰ λ©”μ‹μ§€λ¥Ό λ³΄λ‚Έ μ‚¬μ©μ ID. μ—†μΌλ©΄ null
|===

[source,json]
----
{
    "rooms": [
        {
            "roomId": "3ff392ab-a606-468b-8330-60f3c0d6edf3",
            "name": "group1",
            "url": null,
            "totalMember": 1,
            "unread": 1,
            "content": "hello world",
            "chatId": "1418e71356571000",
            "sender": 1
        },
        {
            "roomId": "9c5ff7dc-5cbe-4b58-b6cf-89ff79d895a9",
            "name": "group",
            "url": null,
            "totalMember": 1,
            "unread": -1,
            "content": null,
            "chatId": null,
            "sender": null
        }
    ]
}
----

'''
==== - [new-message]
λ‹¤μμ€ SSE μ‹¤μ‹κ°„ λ©”μ‹μ§€(new-message)λ΅ μ „λ‹¬λλ” μƒλ΅μ΄ μ±„ν… λ°μ΄ν„°μ— λ€ν• ν•„λ“ μ„¤λ…μ΄λ‹¤.

|===
| Path | Type | Description

| id
| String
| λ©”μ‹μ§€ ID. 64λΉ„νΈ κΈ°λ° μ»¤μ¤ν…€ ID (μ •λ ¬Β·μ •ν•©μ„± ν™•λ³΄μ©)

| roomId
| String
| λ©”μ‹μ§€κ°€ μ†ν• μ±„ν…λ°© ID (UUID)

| type
| String
| λ©”μ‹μ§€ νƒ€μ…
μ: `TEXT`, `IMAGE`, `JOIN`, `LEAVE` λ“±

| message
| String
| λ©”μ‹μ§€ λ³Έλ¬Έ. ν…μ¤νΈ λ©”μ‹μ§€κ°€ μ•„λ‹ κ²½μ° λ‹¤λ¥Έ ν•„λ“μ™€ μ΅°ν•©ν•΄ μ‚¬μ©λ  μ μμ

| sender
| Number
| λ©”μ‹μ§€λ¥Ό λ³΄λ‚Έ μ‚¬μ©μ ID
|===


[source,json]
----
{
    "id": "1418e7ad87971000",
    "roomId": "3ff392ab-a606-468b-8330-60f3c0d6edf3",
    "type": "TEXT",
    "message": "hello world",
    "sender": 1
}
----